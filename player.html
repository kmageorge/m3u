<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>M3U Studio Player</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
    }
    .card-hover {
      transition: all 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(139, 92, 246, 0.3);
    }
    .scrollbar-thin::-webkit-scrollbar {
      width: 8px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.5);
      border-radius: 4px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: rgba(139, 92, 246, 0.7);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // API helpers
    const API_BASE = window.location.origin;

  async function apiCall(endpoint, options = {}) {
      const token = localStorage.getItem('player_token');
      const headers = {
        'Content-Type': 'application/json',
        ...(token && { 'Authorization': `Bearer ${token}` }),
        ...options.headers,
      };

      const res = await fetch(`${API_BASE}${endpoint}`, {
        ...options,
        headers,
      });

      if (res.status === 401) {
        localStorage.removeItem('player_token');
        window.location.reload();
        throw new Error('Unauthorized');
      }

      if (!res.ok) {
        const error = await res.text();
        throw new Error(error || `Request failed: ${res.status}`);
      }

      return res.json();
    }

    // LocalStorage helpers (player-side)
    function readLS(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const parsed = JSON.parse(raw);
        return parsed ?? fallback;
      } catch {
        return fallback;
      }
    }

    // Video Player Component
    function VideoPlayer({ url, title, onClose }) {
      const videoRef = useRef(null);
      const playerRef = useRef(null);
  const fallbackRef = useRef({ tried: false, triedProxy: false, transcodeId: null });

      useEffect(() => {
        if (!videoRef.current || !url) return;

        const isSafari = !!(window.videojs && window.videojs.browser && window.videojs.browser.IS_SAFARI);
  const player = window.videojs(videoRef.current, {
          controls: true,
          autoplay: false,
          muted: false,
          preload: 'auto',
          fluid: true,
          responsive: true,
          aspectRatio: '16:9',
          controlBar: {
            volumePanel: { inline: false },
            audioTrackButton: true
          },
          html5: {
            vhs: {
              overrideNative: !isSafari
            },
            nativeVideoTracks: false,
            nativeAudioTracks: false,
            nativeTextTracks: false
          }
        });

        function setSource(u) {
          player.src({
            src: u,
            type: u.includes('.m3u8') ? 'application/x-mpegURL' 
                 : u.includes('.mpd') ? 'application/dash+xml'
                 : 'video/mp4'
          });
        }

        setSource(url);

        async function tryProxyThenTranscode() {
          // First attempt: try CORS-safe proxy for direct sources (skip for HLS/DASH)
          if (!fallbackRef.current.triedProxy && !(/\.m3u8($|\?)/.test(url) || /\.mpd($|\?)/.test(url))) {
            fallbackRef.current.triedProxy = true;
            try {
              const proxied = `/proxy?url=${encodeURIComponent(url)}`;
              setSource(proxied);
              await player.play();
              return; // success
            } catch (e) {
              // fall through to transcode
            }
          }

          // Second attempt: server-side transcode to HLS
          if (fallbackRef.current.tried) return;
          fallbackRef.current.tried = true;
          try {
            const resp = await fetch('/api/transcode/start', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ src: url })
            });
            if (!resp.ok) throw new Error('transcode start failed');
            const data = await resp.json();
            fallbackRef.current.transcodeId = data.id;
            setSource(data.playlistUrl);
            player.play();
          } catch (e) {
            console.warn('Transcode fallback failed:', e);
          }
        }

        player.ready(() => {
          try {
            player.muted(false);
            player.volume(1);
          } catch {}
          // Attach error handler as early as possible and retry via proxy/transcode
          player.on('error', () => {
            tryProxyThenTranscode();
          });
        });

        playerRef.current = player;

        return () => {
          if (player && !player.isDisposed()) {
            player.dispose();
          }
          // Stop transcode session if any
          if (fallbackRef.current.transcodeId) {
            fetch('/api/transcode/stop', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: fallbackRef.current.transcodeId })
            }).catch(()=>{});
          }
        };
      }, [url]);

      return (
        <div className="fixed inset-0 z-50 bg-black/95 backdrop-blur-sm flex items-center justify-center p-4">
          <div className="w-full max-w-6xl">
            {/* Header */}
            <div className="flex items-center justify-between mb-4 px-2">
              <h2 className="text-2xl font-bold text-white">{title}</h2>
              <button
                onClick={() => {
                  if (playerRef.current) {
                    playerRef.current.dispose();
                    playerRef.current = null;
                  }
                  onClose();
                }}
                className="text-white hover:text-red-400 transition-colors text-3xl"
              >
                ‚úï
              </button>
            </div>
            
            {/* Video Player */}
            <div className="relative w-full" style={{ paddingTop: '56.25%' }}>
              <div className="absolute inset-0">
                <video
                  ref={videoRef}
                  className="video-js vjs-big-play-centered vjs-theme-fantasy"
                  crossOrigin="anonymous"
                  playsInline
                />
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Helpers for show/episode titles
    function stripShowName(title, showName) {
      try {
        if (!title) return "";
        let t = String(title).trim();
        const s = (showName || "").trim();
        if (!s) return t;
        const lower = t.toLowerCase();
        const sLower = s.toLowerCase();
        if (lower.startsWith(sLower)) {
          let rest = t.slice(s.length);
          // remove leading separators like ":", "-", "‚Äì", "‚Äî" and surrounding spaces
          rest = rest.replace(/^\s*[:\-‚Äì‚Äî]\s*/, "");
          return rest.trim();
        }
        return t;
      } catch {
        return title || "";
      }
    }

    function getEpisodeTitle(show, ep) {
      const cleaned = stripShowName(ep?.title || "", show?.name || "");
      return cleaned || `Episode ${ep?.episode ?? ""}`;
    }

    // Main Player App
    function PlayerApp() {
      const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
      const [authView, setAuthView] = useState('login');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [username, setUsername] = useState('');
      const [error, setError] = useState('');

  const [activeTab, setActiveTab] = useState('channels');
  const [channels, setChannels] = useState([]);
  const [movies, setMovies] = useState([]);
  const [shows, setShows] = useState([]);
  // Shows drill-down state
  const [selectedShow, setSelectedShow] = useState(null); // full show object
  const [selectedSeason, setSelectedSeason] = useState(null); // season number
      const [searchQuery, setSearchQuery] = useState('');
      const [selectedGenre, setSelectedGenre] = useState('all');
      
      const [nowPlaying, setNowPlaying] = useState(null);

      // Initial load: prefer LocalStorage; auth is optional and non-blocking
      useEffect(() => {
        loadLibraryLS();
        checkAuth().finally(() => setLoading(false));
      }, []);

      async function checkAuth() {
        try {
          const data = await apiCall('/api/auth/me');
          setUser(data.user);
          // Optionally refresh from API if LS empty
          if (channels.length === 0 && movies.length === 0 && shows.length === 0) {
            loadLibraryFromAPI();
          }
        } catch (err) {
          console.log('Not authenticated');
        }
      }

  async function handleLogin(e) {
        e.preventDefault();
        setError('');
        try {
          const data = await apiCall('/api/auth/login', {
            method: 'POST',
            body: JSON.stringify({ email, password }),
          });
          localStorage.setItem('player_token', data.token);
          setUser(data.user);
          // After login, try refreshing from API as well
          await loadLibraryFromAPI();
        } catch (err) {
          setError(err.message);
        }
      }

      async function handleRegister(e) {
        e.preventDefault();
        setError('');
        try {
          const data = await apiCall('/api/auth/register', {
            method: 'POST',
            body: JSON.stringify({ username, email, password }),
          });
          localStorage.setItem('player_token', data.token);
          setUser(data.user);
          loadLibrary();
        } catch (err) {
          setError(err.message);
        }
      }

      function handleLogout() {
        localStorage.removeItem('player_token');
        setUser(null);
        setChannels([]);
        setMovies([]);
        setShows([]);
        // Reload from LS after logout
        loadLibraryLS();
      }

      // Prefer LocalStorage
      function loadLibraryLS() {
        try {
          const lsChannels = readLS('m3u_channels', []);
          const lsMovies = readLS('m3u_movies', []);
          const lsShows = readLS('m3u_shows', []);
          setChannels(Array.isArray(lsChannels) ? lsChannels.filter(c => c?.url) : []);
          setMovies(Array.isArray(lsMovies) ? lsMovies.filter(m => m?.url) : []);
          const showsPlayable = Array.isArray(lsShows) ? lsShows.filter(s => s?.seasons?.some(sea => sea?.episodes?.some(ep => ep?.url))) : [];
          setShows(showsPlayable);
        } catch (err) {
          console.error('Failed to read from localStorage:', err);
        }
      }

      // Optional: fallback to API (if authenticated)
      async function loadLibraryFromAPI() {
        try {
          const [channelsData, moviesData, showsData] = await Promise.all([
            apiCall('/api/db/channels'),
            apiCall('/api/db/movies'),
            apiCall('/api/db/shows'),
          ]);
          setChannels((channelsData.items || []).filter(c => c.url));
          setMovies((moviesData.items || []).filter(m => m.url));
          setShows((showsData.items || []).filter(s => s.seasons?.some(sea => sea.episodes?.some(ep => ep.url))));
        } catch (err) {
          // Silent if unauth or API unavailable; LS remains the source of truth
          console.warn('API library load skipped or failed:', err?.message || err);
        }
      }

      function refreshFromLocalStorage() {
        loadLibraryLS();
      }

      function playChannel(channel) {
        setNowPlaying({
          url: channel.url,
          title: channel.name || 'Live Channel',
          type: 'channel'
        });
      }

      function playMovie(movie) {
        setNowPlaying({
          url: movie.url,
          title: movie.title || 'Movie',
          type: 'movie'
        });
      }

      function playEpisode(show, season, episode) {
        setNowPlaying({
          url: episode.url,
          title: `${show.name} - S${season.season}E${episode.episode}${episode.title ? ': ' + episode.title : ''}`,
          type: 'episode'
        });
      }

      if (loading) {
        return (
          <div className="min-h-screen gradient-bg flex items-center justify-center">
            <div className="text-white text-2xl">Loading...</div>
          </div>
        );
      }

      // Only show login UI if not authenticated AND no content in LS
      if (!user && channels.length === 0 && movies.length === 0 && shows.length === 0) {
        return (
          <div className="min-h-screen gradient-bg flex items-center justify-center p-4">
            <div className="w-full max-w-md bg-slate-900/90 backdrop-blur-xl border border-purple-500/20 rounded-2xl p-8 shadow-2xl">
              <div className="text-center mb-8">
                <h1 className="text-4xl font-bold text-white mb-2">üé¨ M3U Studio</h1>
                <p className="text-slate-400">Stream your media library</p>
              </div>

              {error && (
                <div className="mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-200 text-sm">
                  {error}
                </div>
              )}

              <div className="flex gap-2 mb-6">
                <button
                  onClick={() => setAuthView('login')}
                  className={`flex-1 py-2 px-4 rounded-lg font-semibold transition-all ${
                    authView === 'login'
                      ? 'bg-purple-600 text-white'
                      : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                  }`}
                >
                  Login
                </button>
                <button
                  onClick={() => setAuthView('register')}
                  className={`flex-1 py-2 px-4 rounded-lg font-semibold transition-all ${
                    authView === 'register'
                      ? 'bg-purple-600 text-white'
                      : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                  }`}
                >
                  Register
                </button>
              </div>

              {authView === 'login' ? (
                <form onSubmit={handleLogin} className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2">Email</label>
                    <input
                      type="email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      className="w-full px-4 py-3 rounded-lg bg-slate-800 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2">Password</label>
                    <input
                      type="password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      className="w-full px-4 py-3 rounded-lg bg-slate-800 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                      required
                    />
                  </div>
                  <button
                    type="submit"
                    className="w-full py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-semibold rounded-lg hover:opacity-90 transition-all"
                  >
                    Login
                  </button>
                </form>
              ) : (
                <form onSubmit={handleRegister} className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2">Username</label>
                    <input
                      type="text"
                      value={username}
                      onChange={(e) => setUsername(e.target.value)}
                      className="w-full px-4 py-3 rounded-lg bg-slate-800 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2">Email</label>
                    <input
                      type="email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      className="w-full px-4 py-3 rounded-lg bg-slate-800 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2">Password</label>
                    <input
                      type="password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      className="w-full px-4 py-3 rounded-lg bg-slate-800 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                      required
                    />
                  </div>
                  <button
                    type="submit"
                    className="w-full py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-semibold rounded-lg hover:opacity-90 transition-all"
                  >
                    Register
                  </button>
                </form>
              )}
            </div>
          </div>
        );
      }

      // Filter content based on search and genre
      const filteredChannels = channels.filter(c => {
        const matchSearch = !searchQuery || c.name?.toLowerCase().includes(searchQuery.toLowerCase());
        const matchGenre = selectedGenre === 'all' || c.group === selectedGenre;
        return matchSearch && matchGenre;
      });

      const filteredMovies = movies.filter(m => {
        const matchSearch = !searchQuery || m.title?.toLowerCase().includes(searchQuery.toLowerCase());
        const matchGenre = selectedGenre === 'all' || m.genres?.includes(selectedGenre);
        return matchSearch && matchGenre;
      });

      const filteredShows = shows.filter(s => {
        const matchSearch = !searchQuery || s.name?.toLowerCase().includes(searchQuery.toLowerCase());
        const matchGenre = selectedGenre === 'all' || s.genres?.includes(selectedGenre);
        return matchSearch && matchGenre;
      });

      // Get unique genres
      const channelGroups = ['all', ...new Set(channels.map(c => c.group).filter(Boolean))];
      const movieGenres = ['all', ...new Set(movies.flatMap(m => (m.genres || '').split(', ')).filter(Boolean))];
      const showGenres = ['all', ...new Set(shows.flatMap(s => (s.genres || '').split(', ')).filter(Boolean))];

      let genres = [];
      if (activeTab === 'channels') genres = channelGroups;
      else if (activeTab === 'movies') genres = movieGenres;
      else if (activeTab === 'shows') genres = showGenres;

      return (
        <div className="min-h-screen gradient-bg">
          {/* Header */}
          <header className="bg-slate-900/80 backdrop-blur-md border-b border-purple-500/20 sticky top-0 z-40">
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <h1 className="text-2xl font-bold text-white">üé¨ M3U Studio Player</h1>
                  <span className="px-3 py-1 bg-purple-600/20 border border-purple-500/30 rounded-full text-sm text-purple-300">
                    {user ? user.username : 'Guest'}
                  </span>
                </div>
                <div className="flex items-center gap-4">
                  <a
                    href="/"
                    className="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-all"
                  >
                    üìä Admin
                  </a>
                  <button
                    onClick={refreshFromLocalStorage}
                    className="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-all"
                    title="Reload from localStorage"
                  >
                    üîÑ Refresh
                  </button>
                  {user ? (
                    <button
                      onClick={handleLogout}
                      className="px-4 py-2 bg-red-600/20 hover:bg-red-600/30 text-red-300 rounded-lg transition-all"
                    >
                      Logout
                    </button>
                  ) : null}
                </div>
              </div>
            </div>
          </header>

          {/* Navigation */}
          <div className="bg-slate-900/60 backdrop-blur-sm border-b border-slate-700/50">
            <div className="max-w-7xl mx-auto px-4">
              <div className="flex gap-2 py-4">
                <button
                  onClick={() => { setActiveTab('channels'); setSearchQuery(''); setSelectedGenre('all'); }}
                  className={`px-6 py-2 rounded-lg font-semibold transition-all ${
                    activeTab === 'channels'
                      ? 'bg-purple-600 text-white'
                      : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                  }`}
                >
                  üì∫ Channels ({channels.length})
                </button>
                <button
                  onClick={() => { setActiveTab('movies'); setSearchQuery(''); setSelectedGenre('all'); }}
                  className={`px-6 py-2 rounded-lg font-semibold transition-all ${
                    activeTab === 'movies'
                      ? 'bg-purple-600 text-white'
                      : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                  }`}
                >
                  üé• Movies ({movies.length})
                </button>
                <button
                  onClick={() => { setActiveTab('shows'); setSearchQuery(''); setSelectedGenre('all'); setSelectedShow(null); setSelectedSeason(null); }}
                  className={`px-6 py-2 rounded-lg font-semibold transition-all ${
                    activeTab === 'shows'
                      ? 'bg-purple-600 text-white'
                      : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                  }`}
                >
                  üé¨ Shows ({shows.length})
                </button>
              </div>
            </div>
          </div>

          {/* Search and Filter Bar */}
          <div className="bg-slate-900/40 backdrop-blur-sm border-b border-slate-700/50">
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex flex-col sm:flex-row gap-4">
                <input
                  type="text"
                  placeholder={`Search ${activeTab}...`}
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="flex-1 px-4 py-2 rounded-lg bg-slate-800 border border-slate-700 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                />
                <select
                  value={selectedGenre}
                  onChange={(e) => setSelectedGenre(e.target.value)}
                  className="px-4 py-2 rounded-lg bg-slate-800 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                >
                  {genres.map(g => (
                    <option key={g} value={g}>{g === 'all' ? 'All Genres' : g}</option>
                  ))}
                </select>
              </div>
            </div>
          </div>

          {/* Content */}
          <div className="max-w-7xl mx-auto px-4 py-8">
            {activeTab === 'channels' && (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {filteredChannels.map(channel => (
                  <div
                    key={channel.id}
                    className="bg-slate-900/80 backdrop-blur-sm border border-slate-700 rounded-xl p-4 card-hover cursor-pointer"
                    onClick={() => playChannel(channel)}
                  >
                    <div className="flex items-center gap-3 mb-3">
                      {channel.logo ? (
                        <img src={channel.logo} alt="" className="w-16 h-16 rounded-lg object-cover border border-slate-700" />
                      ) : (
                        <div className="w-16 h-16 rounded-lg bg-slate-800 flex items-center justify-center text-3xl">
                          üì∫
                        </div>
                      )}
                      <div className="flex-1 min-w-0">
                        <h3 className="text-white font-semibold truncate">{channel.name}</h3>
                        {channel.group && (
                          <span className="text-xs text-slate-400">{channel.group}</span>
                        )}
                      </div>
                    </div>
                    <button className="w-full py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all font-semibold">
                      ‚ñ∂Ô∏è Play Now
                    </button>
                  </div>
                ))}
                {filteredChannels.length === 0 && (
                  <div className="col-span-full text-center py-16">
                    <div className="text-6xl mb-4">üì∫</div>
                    <p className="text-slate-400 text-xl">No channels found</p>
                  </div>
                )}
              </div>
            )}

            {activeTab === 'movies' && (
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                {filteredMovies.map(movie => (
                  <div
                    key={movie.id}
                    className="bg-slate-900/80 backdrop-blur-sm border border-slate-700 rounded-xl overflow-hidden card-hover cursor-pointer"
                    onClick={() => playMovie(movie)}
                  >
                    {movie.poster ? (
                      <img src={movie.poster} alt="" className="w-full aspect-[2/3] object-cover" />
                    ) : (
                      <div className="w-full aspect-[2/3] bg-slate-800 flex items-center justify-center text-6xl">
                        üé•
                      </div>
                    )}
                    <div className="p-4">
                      <h3 className="text-white font-semibold truncate mb-1">{movie.title}</h3>
                      <div className="flex items-center gap-2 text-xs text-slate-400 mb-3">
                        {movie.year && <span>{movie.year}</span>}
                        {movie.rating > 0 && <span>‚≠ê {movie.rating.toFixed(1)}</span>}
                      </div>
                      <button className="w-full py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all font-semibold text-sm">
                        ‚ñ∂Ô∏è Play
                      </button>
                    </div>
                  </div>
                ))}
                {filteredMovies.length === 0 && (
                  <div className="col-span-full text-center py-16">
                    <div className="text-6xl mb-4">üé•</div>
                    <p className="text-slate-400 text-xl">No movies found</p>
                  </div>
                )}
              </div>
            )}

            {activeTab === 'shows' && (
              <div className="space-y-6">
                {/* Breadcrumbs / Header Controls */}
                <div className="flex items-center gap-3">
                  {selectedShow && (
                    <button
                      onClick={() => { setSelectedShow(null); setSelectedSeason(null); }}
                      className="px-3 py-1.5 rounded-lg text-sm font-semibold bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700 transition-all"
                    >
                      ‚Üê All Shows
                    </button>
                  )}
                  {selectedShow && selectedSeason != null && (
                    <button
                      onClick={() => setSelectedSeason(null)}
                      className="px-3 py-1.5 rounded-lg text-sm font-semibold bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700 transition-all"
                    >
                      ‚Üê Seasons
                    </button>
                  )}
                </div>

                {/* Level 1: Shows Grid */}
                {!selectedShow && (
                  <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                    {filteredShows.map(show => (
                      <div
                        key={show.id}
                        className="bg-slate-900/80 backdrop-blur-sm border border-slate-700 rounded-xl overflow-hidden card-hover cursor-pointer"
                        onClick={() => { setSelectedShow(show); setSelectedSeason(null); }}
                      >
                        {show.poster ? (
                          <img src={show.poster} alt="" className="w-full aspect-[2/3] object-cover" />
                        ) : (
                          <div className="w-full aspect-[2/3] bg-slate-800 flex items-center justify-center text-6xl">
                            üé¨
                          </div>
                        )}
                        <div className="p-4">
                          <h3 className="text-white font-semibold truncate mb-1">{show.name}</h3>
                          {show.genres && (
                            <div className="flex items-center gap-2 text-xs text-slate-400 mb-2 truncate">
                              {show.genres.split(', ').slice(0,2).map(g => (<span key={g}>{g}</span>))}
                            </div>
                          )}
                          <button className="w-full py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all font-semibold text-sm">
                            View Seasons
                          </button>
                        </div>
                      </div>
                    ))}
                    {filteredShows.length === 0 && (
                      <div className="col-span-full text-center py-16">
                        <div className="text-6xl mb-4">üé¨</div>
                        <p className="text-slate-400 text-xl">No shows found</p>
                      </div>
                    )}
                  </div>
                )}

                {/* Level 2: Seasons Grid for Selected Show */}
                {selectedShow && selectedSeason == null && (() => {
                  const seasonsWithEpisodes = (selectedShow.seasons || [])
                    .map(season => ({
                      season: season.season,
                      episodes: (season.episodes || []).filter(ep => ep.url)
                    }))
                    .filter(season => season.episodes.length > 0)
                    .sort((a, b) => a.season - b.season);

                  return (
                    <div className="space-y-4">
                      {/* Selected Show Header */}
                      <div className="flex items-center gap-4">
                        {selectedShow.poster ? (
                          <img src={selectedShow.poster} alt="" className="w-16 h-24 rounded-lg object-cover border border-slate-700" />
                        ) : (
                          <div className="w-16 h-24 rounded-lg bg-slate-800 flex items-center justify-center text-3xl">üé¨</div>
                        )}
                        <div>
                          <h2 className="text-2xl font-bold text-white">{selectedShow.name}</h2>
                          <div className="text-sm text-slate-400">
                            {seasonsWithEpisodes.length} Season{seasonsWithEpisodes.length !== 1 ? 's' : ''}
                          </div>
                        </div>
                      </div>
                      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        {seasonsWithEpisodes.map(s => (
                          <div
                            key={s.season}
                            className="bg-slate-900/70 border border-slate-700 rounded-xl p-4 cursor-pointer hover:border-purple-500/40 transition-all"
                            onClick={() => setSelectedSeason(s.season)}
                          >
                            <div className="text-white font-semibold">Season {s.season}</div>
                            <div className="text-xs text-slate-400">{s.episodes.length} episode{s.episodes.length !== 1 ? 's' : ''}</div>
                          </div>
                        ))}
                        {seasonsWithEpisodes.length === 0 && (
                          <div className="col-span-full text-center py-8 text-slate-400">No seasons with playable episodes</div>
                        )}
                      </div>
                    </div>
                  );
                })()}

                {/* Level 3: Episodes List for Selected Season */}
                {selectedShow && selectedSeason != null && (() => {
                  const seasonObj = (selectedShow.seasons || []).find(sea => sea.season === selectedSeason);
                  const episodes = (seasonObj?.episodes || []).filter(ep => ep.url);
                  return (
                    <div className="space-y-4">
                      {/* Header */}
                      <div className="flex items-center gap-3">
                        <h2 className="text-xl font-bold text-white">{selectedShow.name} ‚Äî Season {selectedSeason}</h2>
                        <span className="text-sm text-slate-400">{episodes.length} episode{episodes.length !== 1 ? 's' : ''}</span>
                      </div>
                      <div className="space-y-2">
                        {episodes.map(ep => (
                          <div
                            key={ep.episode}
                            className="flex items-start gap-3 p-3 bg-slate-900/60 hover:bg-slate-900/80 rounded-lg transition-all cursor-pointer group border border-transparent hover:border-purple-500/30"
                            onClick={() => playEpisode(selectedShow, { season: selectedSeason }, ep)}
                          >
                            <div className="flex-shrink-0 w-10 h-10 bg-purple-600/20 rounded-lg flex items-center justify-center text-purple-300 font-bold group-hover:bg-purple-600 group-hover:text-white transition-all">
                              {ep.episode}
                            </div>
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center justify-between gap-2">
                                <h4 className="text-sm font-semibold text-white truncate">{getEpisodeTitle(selectedShow, ep)}</h4>
                                <button className="flex-shrink-0 w-8 h-8 rounded-full bg-purple-600/20 group-hover:bg-purple-600 text-purple-300 group-hover:text-white flex items-center justify-center transition-all">‚ñ∂Ô∏è</button>
                              </div>
                              {ep.overview && (
                                <p className="text-xs text-slate-500 line-clamp-2 leading-relaxed mt-1">{ep.overview}</p>
                              )}
                            </div>
                          </div>
                        ))}
                        {episodes.length === 0 && (
                          <div className="text-center py-8 text-slate-400">No playable episodes in this season</div>
                        )}
                      </div>
                    </div>
                  );
                })()}
              </div>
            )}
          </div>

          {/* Video Player Modal */}
          {nowPlaying && (
            <VideoPlayer
              url={nowPlaying.url}
              title={nowPlaying.title}
              onClose={() => setNowPlaying(null)}
            />
          )}
        </div>
      );
    }

    // Render app
    ReactDOM.render(<PlayerApp />, document.getElementById('root'));
  </script>
</body>
</html>
